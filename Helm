apiVersion: kubevirt.io/v1
kind: VirtualMachine
metadata:
  name: {{ .Values.vm_name }}
  namespace: {{ .Values.namespace }}
spec:
  running: true
  dataVolumeTemplates:
    - metadata:
        name: {{ .Values.vm_name }}-volume
      spec:
        storage:
          resources:
            requests:
              storage: {{ .Values.storage_size }}
          storageClassName: ocs-storagecluster-ceph-rbd-virtualization
        source:
          http:
            url: {{ .Values.image_url }}
  template:
    metadata:
      labels:
        kubevirt.io/vm: {{ .Values.vm_name }}
    spec:
      domain:
        cpu:
          cores: {{ .Values.cpu }}
        resources:
          requests:
            memory: {{ .Values.memory }}
        devices:
          disks:
            - name: rootdisk
              disk:
                bus: virtio
            - name: cloudinitdisk
              disk:
                bus: virtio
            {{- range .Values.volumes }}
            {{- if .enabled }}
            - name: {{ .name }}
              disk:
                bus: virtio
            {{- end }}
            {{- end }}
      networks:
        - name: default
          multus:
            networkName: default/vlan3702
      volumes:
        - name: rootdisk
          dataVolume:
            name: {{ .Values.vm_name }}-volume
        - name: cloudinitdisk
          cloudInitNoCloud:
            secretRef:
              name: {{ .Values.vm_name }}-secret
            networkData: |
              version: 2
              ethernets:
                eth0:
                  dhcp4: false
                  addresses:
                    - {{ .Values.ip }}
                  gateway4: 10.14.221.129
                  nameservers:
                    addresses:
                      - 10.240.47.3
                      - 10.240.41.3
        {{- range .Values.volumes }}
        {{- if .enabled }}
        - name: {{ .name }}
          persistentVolumeClaim:
            claimName: {{ .name }}
        {{- end }}
        {{- end }}
